<!DOCTYPE html><html lang="en" data-astro-cid-bvzihdzo> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="generator" content="Astro v3.5.5"><!-- Font preloads --><link rel="preload" href="/fonts/atkinson-regular.woff" as="font" type="font/woff" crossorigin><link rel="preload" href="/fonts/atkinson-bold.woff" as="font" type="font/woff" crossorigin><!-- Canonical URL --><link rel="canonical" href="https://example.com/blog/module-design/"><!-- Primary Meta Tags --><title>Module design</title><meta name="title" content="Module design"><meta name="description" content="What we probably should think about when designing modules"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://example.com/blog/module-design/"><meta property="og:title" content="Module design"><meta property="og:description" content="What we probably should think about when designing modules"><meta property="og:image" content="https://example.com/blog-placeholder-1.jpg"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://example.com/blog/module-design/"><meta property="twitter:title" content="Module design"><meta property="twitter:description" content="What we probably should think about when designing modules"><meta property="twitter:image" content="https://example.com/blog-placeholder-1.jpg"><link rel="stylesheet" href="/_astro/about.c6024a49.css" />
<style>a[data-astro-cid-eimmu3lg]{display:inline-block;text-decoration:none;font-weight:700}a[data-astro-cid-eimmu3lg].active{font-weight:bolder;text-decoration:underline}
footer[data-astro-cid-sz7xmlte]{padding:2em 1em 6em;background:linear-gradient(var(--gray-gradient)) no-repeat;color:rgb(var(--gray));text-align:center}.social-links[data-astro-cid-sz7xmlte]{display:flex;justify-content:center;gap:1em;margin-top:1em}.social-links[data-astro-cid-sz7xmlte] a[data-astro-cid-sz7xmlte]{text-decoration:none;color:rgb(var(--gray))}.social-links[data-astro-cid-sz7xmlte] a[data-astro-cid-sz7xmlte]:hover{color:rgb(var(--gray-dark))}@media print{footer[data-astro-cid-sz7xmlte]{display:none}}
.hero-image[data-astro-cid-bvzihdzo]{width:100%}.hero-image[data-astro-cid-bvzihdzo] img[data-astro-cid-bvzihdzo]{display:block;margin:0 auto;border-radius:12px;box-shadow:var(--box-shadow)}.title[data-astro-cid-bvzihdzo]{margin-bottom:1em;padding:1em 0;text-align:center;line-height:1}.title[data-astro-cid-bvzihdzo] h1[data-astro-cid-bvzihdzo]{margin:0 0 .5em}.date[data-astro-cid-bvzihdzo]{margin-bottom:.5em;font-style:italic}.last-updated-on[data-astro-cid-bvzihdzo]{font-style:italic}.astro-code[data-astro-cid-bvzihdzo]{margin-bottom:.5em}
</style></head> <body data-astro-cid-bvzihdzo> <header data-astro-cid-3ef6ksr2> <nav class="container mx-auto" data-astro-cid-3ef6ksr2> <h2 data-astro-cid-3ef6ksr2><a href="/" data-astro-cid-3ef6ksr2>Home</a></h2> <div class="internal-links" data-astro-cid-3ef6ksr2> <a href="/blog" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg> Blog </a>  <a href="/about" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg> About me </a>  </div> <div class="social-links" data-astro-cid-3ef6ksr2> <a href="https://github.com/gabjauf" target="_blank" data-astro-cid-3ef6ksr2> <span class="sr-only" data-astro-cid-3ef6ksr2>Go to Astro's GitHub repo</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" data-astro-cid-3ef6ksr2><path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" data-astro-cid-3ef6ksr2></path></svg> </a> </div> </nav> </header>  <main class="container py-32" data-astro-cid-bvzihdzo> <article data-astro-cid-bvzihdzo> <div class="hero-image" data-astro-cid-bvzihdzo> <img width="1020" height="510" src="/blog-placeholder-3.jpg" alt="hero image" data-astro-cid-bvzihdzo> </div> <div class="prose" data-astro-cid-bvzihdzo> <div class="title" data-astro-cid-bvzihdzo> <div class="date" data-astro-cid-bvzihdzo> <time datetime="2023-11-24T00:00:00.000Z"> Nov 24, 2023 </time>  </div> <h1 data-astro-cid-bvzihdzo>Module design</h1> <hr data-astro-cid-bvzihdzo> </div>  <p>Today I stumbled upon some code found on an npm module:</p>
<pre class="astro-code monokai" style="background-color:#272822;color:#F8F8F2; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#66D9EF;font-style:italic">function</span><span style="color:#A6E22E"> template</span><span style="color:#F8F8F2">(</span><span style="color:#FD971F;font-style:italic">string</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic">    var</span><span style="color:#F8F8F2"> args</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F92672">    if</span><span style="color:#F8F8F2"> (</span><span style="color:#FD971F">arguments</span><span style="color:#F8F8F2">.length </span><span style="color:#F92672">===</span><span style="color:#AE81FF"> 2</span><span style="color:#F92672"> &#x26;&#x26;</span><span style="color:#F92672"> typeof</span><span style="color:#FD971F"> arguments</span><span style="color:#F8F8F2">[</span><span style="color:#AE81FF">1</span><span style="color:#F8F8F2">] </span><span style="color:#F92672">===</span><span style="color:#E6DB74"> "object"</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#F8F8F2">        args </span><span style="color:#F92672">=</span><span style="color:#FD971F"> arguments</span><span style="color:#F8F8F2">[</span><span style="color:#AE81FF">1</span><span style="color:#F8F8F2">]</span></span>
<span class="line"><span style="color:#F8F8F2">    } </span><span style="color:#F92672">else</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#F8F8F2">        args </span><span style="color:#F92672">=</span><span style="color:#F92672"> new</span><span style="color:#A6E22E"> Array</span><span style="color:#F8F8F2">(</span><span style="color:#FD971F">arguments</span><span style="color:#F8F8F2">.length </span><span style="color:#F92672">-</span><span style="color:#AE81FF"> 1</span><span style="color:#F8F8F2">)</span></span>
<span class="line"><span style="color:#F92672">        for</span><span style="color:#F8F8F2"> (</span><span style="color:#66D9EF;font-style:italic">var</span><span style="color:#F8F8F2"> i </span><span style="color:#F92672">=</span><span style="color:#AE81FF"> 1</span><span style="color:#F8F8F2">; i </span><span style="color:#F92672">&#x3C;</span><span style="color:#FD971F"> arguments</span><span style="color:#F8F8F2">.length; </span><span style="color:#F92672">++</span><span style="color:#F8F8F2">i) {</span></span>
<span class="line"><span style="color:#F8F8F2">            args[i </span><span style="color:#F92672">-</span><span style="color:#AE81FF"> 1</span><span style="color:#F8F8F2">] </span><span style="color:#F92672">=</span><span style="color:#FD971F"> arguments</span><span style="color:#F8F8F2">[i]</span></span>
<span class="line"><span style="color:#F8F8F2">        }</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F92672">    if</span><span style="color:#F8F8F2"> (</span><span style="color:#F92672">!</span><span style="color:#F8F8F2">args </span><span style="color:#F92672">||</span><span style="color:#F92672"> !</span><span style="color:#F8F8F2">args.hasOwnProperty) {</span></span>
<span class="line"><span style="color:#F8F8F2">        args </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> {}</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F92672">    return</span><span style="color:#F8F8F2"> string.</span><span style="color:#A6E22E">replace</span><span style="color:#F8F8F2">(nargs, </span><span style="color:#66D9EF;font-style:italic">function</span><span style="color:#A6E22E"> replaceArg</span><span style="color:#F8F8F2">(</span><span style="color:#FD971F;font-style:italic">match</span><span style="color:#F8F8F2">, </span><span style="color:#FD971F;font-style:italic">i</span><span style="color:#F8F8F2">, </span><span style="color:#FD971F;font-style:italic">index</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic">        var</span><span style="color:#F8F8F2"> result</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F92672">        if</span><span style="color:#F8F8F2"> (string[index </span><span style="color:#F92672">-</span><span style="color:#AE81FF"> 1</span><span style="color:#F8F8F2">] </span><span style="color:#F92672">===</span><span style="color:#E6DB74"> "{"</span><span style="color:#F92672"> &#x26;&#x26;</span></span>
<span class="line"><span style="color:#F8F8F2">            string[index </span><span style="color:#F92672">+</span><span style="color:#F8F8F2"> match.length] </span><span style="color:#F92672">===</span><span style="color:#E6DB74"> "}"</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#F92672">            return</span><span style="color:#F8F8F2"> i</span></span>
<span class="line"><span style="color:#F8F8F2">        } </span><span style="color:#F92672">else</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#F8F8F2">            result </span><span style="color:#F92672">=</span><span style="color:#F8F8F2"> args.</span><span style="color:#A6E22E">hasOwnProperty</span><span style="color:#F8F8F2">(i) </span><span style="color:#F92672">?</span><span style="color:#F8F8F2"> args[i] </span><span style="color:#F92672">:</span><span style="color:#AE81FF"> null</span></span>
<span class="line"><span style="color:#F92672">            if</span><span style="color:#F8F8F2"> (result </span><span style="color:#F92672">===</span><span style="color:#AE81FF"> null</span><span style="color:#F92672"> ||</span><span style="color:#F8F8F2"> result </span><span style="color:#F92672">===</span><span style="color:#AE81FF"> undefined</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#F92672">                return</span><span style="color:#E6DB74"> ""</span></span>
<span class="line"><span style="color:#F8F8F2">            }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F92672">            return</span><span style="color:#F8F8F2"> result</span></span>
<span class="line"><span style="color:#F8F8F2">        }</span></span>
<span class="line"><span style="color:#F8F8F2">    })</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span>
<span class="line"></span></code></pre>
<p>Basically, what this does is just a ”{}” based template engine that you can use like this:</p>
<pre class="astro-code monokai" style="background-color:#272822;color:#F8F8F2; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F8F8F2">greeting </span><span style="color:#F92672">=</span><span style="color:#A6E22E"> template</span><span style="color:#F8F8F2">(</span><span style="color:#E6DB74">"Hello {name}, you have {count} unread messages"</span><span style="color:#F8F8F2">, {</span></span>
<span class="line"><span style="color:#F8F8F2">    name: </span><span style="color:#E6DB74">"Robert"</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#F8F8F2">    count: </span><span style="color:#AE81FF">12</span></span>
<span class="line"><span style="color:#F8F8F2">})</span></span></code></pre>
<p>This is legacy code but still pretty simple right ?
So now, what is the issue with this code ?</p>
<p>Well, simply that the input “string” can be absolutely anything! There are no checks whether this is really a string or something else. This code is then unsafe to run.</p>
<h2 id="ensuring-parameters-types">Ensuring parameters types</h2>
<p>I can see two ways to ensure function parameters types today:</p>
<ul>
<li>Static analysis (for example typescript)</li>
<li>Runtime validation</li>
</ul>
<h3 id="static-analysis">Static analysis</h3>
<p>Typescript is great! It maintains coherence inside the system, given that the inputs you put in the system (user, bot or even dev provided) are exactly like the types you defined for them.</p>
<p>Say now we changed our previous function:</p>
<pre class="astro-code monokai" style="background-color:#272822;color:#F8F8F2; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#66D9EF;font-style:italic">function</span><span style="color:#A6E22E"> template</span><span style="color:#F8F8F2">(</span><span style="color:#FD971F;font-style:italic">string</span><span style="color:#F92672">:</span><span style="color:#66D9EF;font-style:italic"> string</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#F92672">...</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre>
<p>Does it change a thing ?
From a developer point of view, yes. Now this is a small module, with a perfectly well defined interface, that we can just integrate in our code! Now, if we pass a number to this function, the program won’t compile until we fix it.</p>
<p>But let’s say that we are lazy and we pass the input as “any”. Are we still safe ?</p>
<h3 id="runtime-validation">Runtime validation</h3>
<p>Static analysis is insufficient because it is more of a theoretical way of securing programs, provided that they are used with the right inputs. In real life thought, this is not always the case and it can lead to very serious threats.</p>
<p>To mitigate this, we need the use of runtime validation that will coerce the data structures passed as inputs.</p>
<p>Here for example, we could do something like this:</p>
<pre class="astro-code monokai" style="background-color:#272822;color:#F8F8F2; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#66D9EF;font-style:italic">function</span><span style="color:#A6E22E"> template</span><span style="color:#F8F8F2">(</span><span style="color:#FD971F;font-style:italic">string</span><span style="color:#F92672">:</span><span style="color:#66D9EF;font-style:italic"> string</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#F92672">  if</span><span style="color:#F8F8F2"> (</span><span style="color:#F92672">typeof</span><span style="color:#F8F8F2"> string </span><span style="color:#F92672">!==</span><span style="color:#E6DB74"> "string"</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#88846F">    // throw error</span></span>
<span class="line"><span style="color:#F8F8F2">  }</span></span>
<span class="line"><span style="color:#F8F8F2">}</span></span></code></pre>
<p>We now check the value at runtime, ensuring the function cannot be called with non-compliant data-structures.</p>
<h2 id="modules">Modules</h2>
<p>Personnal opinion here. I can call something a module when:</p>
<ul>
<li>Boundaries are identifiable</li>
<li>Boundaries are enforced</li>
</ul>
<p>The first thing is about intent and usability. A module is identifiable only when you know how to call it, how to pass it inputs and the outputs that you get.
The second one is enforcing boundaries so that the inner coherence is maintained, especially if there is some stateful programming happening.</p>
<p>A module does not need to be big. Just a small function like the one I gave as an example is sufficient. We can also consider micro-services as modules and the fact that if they do not provide both of the characteristics above, they may either not be usable or robust.</p>
<h2 id="trust">Trust</h2>
<p>When you install a program on your computer, you sign an implicit contract: you believe that what you installed is safe to run or use. You also believe that it is robust, will work every time you launch it and that it cannot be exploited by hackers easily.</p>
<p>Now, if every single module you install as a developer is like the one upward, do you really think it is possible to make such programs? Even if you are the best developer on earth and you can patch everything from the outside, with unlimited blood, sweat, and tears?</p>
<p>We hold, as developers, great responsibilities here. When we make the choice to publish on npm something that is not robust and bullet proof. When we make the choice to use a non-robust module from the npm registry. When we make the choice to not migrate to more robust modules. (and the last one is also a consequence of the choice to not look under the carpet)</p>
<br>
Further notes:
<ul>
<li>Yeah, the code is a bit messy, and there is probably a lot to say about the “arguments”, that part does not communicate well its intents.</li>
<li>The npm module from which this code was extracted has been downloaded 1,905,290 times last week.</li>
</ul>  </div> </article> </main> <footer data-astro-cid-sz7xmlte>
&copy; 2024 Gabjauf. All rights reserved.
<div class="social-links" data-astro-cid-sz7xmlte> <a href="https://github.com/gabjauf" target="_blank" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>Go to Astro's GitHub repo</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" astro-icon="social/github" data-astro-cid-sz7xmlte><path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" data-astro-cid-sz7xmlte></path></svg> </a> </div> </footer>  </body></html>